% 5.4.3.TestMainGit.tex
%	Last update: 2018/06/18 F.Kanehori
%\newpage
\subsubsection{TestMainGit}
\label{subsubsec:TestMainGit}

\medskip
\noindent
\Ref{subsec}{DailyBuildEnvironmentVariable}で示したstep 4.以降の処理
を実行するプログラム。
ディレクトリ\tt{src, src/tests, src/Samples}を対象とした
``ビルド＆テスト''は下位プログラム\tt{SpringheadTest}で制御するが、
それ以外の処理(テスト履歴ファイルの作成、テスト結果のリポジトリへの登録、
ログファイルのWebサーバへのコピー等)は、このプログラムで直接制御する。

\medskip
\Invoke[b]{%
     > python TestMainGit.py [options]\Cont\\
     \Hskip{100pt}test-repository result-repository
}
\begin{Opts}[b]
    \Item[t]{-c CONF}{ビルド構成 (\tt{Debug, Release\Note, Trace})}
    \Item[t]{-p PLAT}{プラットフォーム (\tt{x86, x64\Note})}
    \Item[t]{-t TOOL}{ツールセット (\tt{14.0\Note})}
    \Item[t]{-D}{コマンドを表示するだけで実行はしない(dry run)}
\end{Opts}
\begin{Args}[b][10em]
    \Item[t]{test-repository}{%
	テストレポジトリ$^{\small (注)}$\\
	任意のディレクトリでよいが、既存のディレクトリの場合には、
	その内容はすべて破棄される。}
    \Item[t]{result-repository}{%
    	テスト結果記録用レポジトリ$^{\small (注)}$\\
	通常\Path{DailyBuildResult/Result}を指定する。}
\end{Args}
\Vskip{.5\baselineskip}
\begin{LocalScope}\tabcolsep=0pt
\begin{Table}[r][2em]{ll}
  \Item{(注)}{これらのディレクトリは、
	テストを起動するディレクトリから3階層上のディレクトリ
	(例えば\Path{top/Springhead/core/test}ならば\Path{top})からの
	相対パスで指定すること。}
\end{Table}
\end{LocalScope}

\begin{Proc}[b]
\begin{enumerate}
  \item ディレクトリ\Path{core/test/bin}に移動する。

  \item	次のディレクトリに対して
	\tt{SpringheadTest}(\Ref{subsubsec}{SpringheadTest})を呼び出して
	テストを実行する。
	\Vskip{-.3\baselineskip}
	\begin{narrow}\begin{tabular}{ll}
	    \tt{core/src} & Springheadライブラリを作成する\\
	    \tt{core/src/tests} & ビルドして実行する\\
	    \tt{core/src/Samples} & ビルドのみ行なう\\
	\end{tabular}\end{narrow}
	\Vskip{.3\baselineskip}

	呼出しコマンドは、\\
	\Cmnd{%
		> python SpringheadTest.py \Cont\\
		\hspace{30pt}-p \it{plat} -c \it{conf} -t \it{tool}
			     -C unuse -S\Cont\\
		\hspace{30pt}\it{dir} result/dailybuild.result
			     dailybuild.control \it{section}
	}
	\begin{Opts}
	    \Item[t]{-p \it{plat}}{\it{plat}は起動引数で指定された値}
	    \Item[t]{-c \it{conf}}{\it{conf}は起動引数で指定された値}
	    \Item[t]{-t \it{tool}}{\it{tool}は起動引数で指定された値}
	    \Item[t]{-C unuse}{Closed soruceを使用しないことを指定}
	    \Item[t]{-S}{Springheadライブラリ作成時のみ指定
			(テスト結果ファイルを初期化する)}
	\end{Opts}
	\begin{Args}[t]
	    \Item[i]{dir}{%
		テスト対象ディレクトリ
		(\Path{.}, \Path{tests}, \Path{Samples}を順に指定)}
	    \Item[t]{section}{%
		テスト制御ファイルセクション名
		(\tt{Windows}または\tt{unix})。
		テスト制御ファイルのどのセクションを対象とするかを指定}
	\end{Args}

  \item	ディレクトリ\Path{core/test/log}に移動する。

  \item	Springheadの最新コミットIDを調べて、
	ファイル\Path{Springhead.commit.id}に出力する。\\
	\Cmnd{%
		> python ../bin/VersionControlSystem.py -G HEAD
	}

  \item 前項で作成したコミットIDファイル\Path{Springhead.commit.id}及び
	テスト結果ファイル\Path{result.log}を
	レポジトリ\Path{DailyBuildResult/Result}にコピーして
	commit and pushする。

  \item	結果履歴ファイル\Path{result.log}を作成する。\\
	\Cmnd{%
	     > python ../bin/VersionControlSystem.py -H -f result.log all
	}

  \item	テスト日付ファイル \Path{test.date} を作成する。
  	ファイルの内容は、\\

	\vspace{-.5\baselineskip}
	\begin{LocalScope}\def\arraystretch{.8}\tabcolsep=10pt
	\hspace{40pt}\tt{\begin{tabular}{|l|}\hline
		** DO NOT EDIT THIS FILE **\\
		generated by "TestMainGit"\\
		- - - \it{YYYY-mmdd HH:MM:SS}\\\hline
	\end{tabular}}
	\end{LocalScope}

	\Vskip{.5\baselineskip}
	である。
	このファイルは、Webページ``ビルドの状況テーブル''の
	日付表示に使用される。

  \item	ログファイルをWebサーバにコピーする。\\
	\begin{tabular}{ll}
	    コピー元 & \tt{test/log/*}\\
	    コピー先 & \PathBgn{\BS\BS haselab\BS HomeDirs\BS WWW\BS docroot\BS\Cont}\\
	    	     & \Hskip{140pt}\PathEnd{springhead\BS dailybuild\BS log}
	\end{tabular}

  \item	ディレクトリ\Path{core/include}に移動して
 	Springheadリファレンスマニュアルを作成する。\\
	\Cmnd{%
		> python SpringheadDoc.py
	}

  \item	ディレクトリ\Path{core/src}に移動して
 	Springhead SDK開発者マニュアルを作成する。\\
	\Cmnd{%
		> python SpringheadImpDoc.py
	}

  \item	ディレクトリ\Path{core/doc/SprManual}に移動して
 	Springhead Users Manualを作成する。\\
	\Cmnd{%
		> python MakeDoc.py
	}
\end{enumerate}
\end{Proc}

% end: 5.4.3.TestMainGit.tex
