% 3.2.CmakeApplication.tex
%	Last update: 2019/07/24 F.Kanehori
%newpage
\subsection{cmakeの実行}
\label{subsec:CmakeApplication}

\noindent
\cmake の実行手順については、
\KQuote{\ref{subsec:CmakeLibrary} cmakeの実行}と同じですから、
そちらを参照してください。
ここでは、\cmake を実行することで
\KQuote{\ref{subsec:Solution} 対処法}で示した対策がどのように実施されるかについて述べます。

\bigskip
\noindent
\bf{ビルドの最適性}
\begin{narrow}[20pt]
	組み込まれているSpringheadライブラリの各プロジェクト
	(ここでは\tt{Base}を例にします)に対して\\
	\hspace{20pt}\SprTop{/core/src/Base}下に
	\Path{\rm{<x64>}/\rm{<15.0>}/Base.dir}$^{\small (*1)}$\\
	というディレクトリを作成し、
	\AppTop{/\build /Base/Base.dir}から上記ディレクトリ$^{\small (*1)}$へ
	linkを張る作業を\cmake\ configure時に(自動的に)行ないます。
\end{narrow}	
\begin{narrow}[20pt]
	\thinrule{\linewidth}\\
	{\bf{これに関して皆さんが行なうべきことはありませんが、
	次のことに注意してください。}}

	\medskip
	\begin{enumerate}
	  \item	\cmake をした後でSpringheadソースツリー上ので上記ディレクトリ
		$^{\small (*1)}$を削除すると、以降のビルドで\\
		\hspace{15pt}\KQuote{\tt{\small{%
		エラー MSB3191 ディレクトリ\Path{Base.dir/Debug/}を作成できません。}}}

		というエラーが発生します。

	  \item	アプリケーション側で\AppTop{/\build /Base/Base.dir}を削除すると、
		ビルド時にVisual Studioが\build 下に\Path{Base.dir}を
		自動的に作成するためにビルドの最適性が崩れてしまいます
		(無駄なビルドが発生するだけで、ビルド自体は正常に行なえます)。
		\begin{narrow}[s][15pt]
		Windowsでは実行権限の都合上linkをjunctionで実現していますが、
		explorerでもcommand prompt上でも\Path{Base.dir}がjunctionか
		通常のディレクトリかの区別ができません。
		そのためこのような事態の発見が困難になる可能性があります。
		\end{narrow}
	\end{enumerate}
	\medskip
	{\bf{これらの状態を解消するためには、アプリケーション側
	(もしくはSpringheadライブラリ側)で再度\cmake を実行する必要があります。}}

	\thinrule{\linewidth}
\end{narrow}

\bigskip
\noindent
\bf{プロジェクトファイルの整合性}
\begin{narrow}[20pt]
	\KQuote{\ref{subsec:Solution} 対処法}でも述べたように、
	プロジェクトファイル(ソリューションファイルの含む。以下同様)は
	Springheadライブラリのビルドツリーにあるものを最新の状態に保つことを前提として、
	アプリケーション側のプロジェクトファイルは
	これらSpringhead側にあるものへのlinkとなるようにします。
	このためにアプリケーションプログラムのソリューションに
	\tt{sync}というターゲットを追加して、次の処理を実行させます。
	\begin{enumerate}
	  \item	もしもアプリケーション側のプロジェクトファイルの内容と
		Springhead側のプロジェクトファイルの内容とが異なっていたならば、
		アプリケーション側のプロジェクトファイルを
		Springhead側にコピーする。
		\begin{narrow}[s][15pt]
		これは、アプリケーション側でソースファイル構成を変更
		(ファイルの追加・削除)を行ない、
		Visual Studio上でプロジェクトファイルを保存したとき、
		またはアプリケーション側で再度\cmake を実行したときです。
		\end{narrow}

	  \item	アプリケーション側のプロジェクトファイルをSpringhead側の
		プロジェクトファイルへのlinkとします。
	\end{enumerate}
	ターゲット\tt{sync}はアプリケーションのビルドにおいて
	必ず最初に実行されるように依存関係が設定されます。
\end{narrow}	
\begin{narrow}[20pt]
	\thinrule{\linewidth}\\
	{\bf{次のことに注意してください。}}

	\medskip
	\begin{enumerate}
	  \item	Springhead側または他のアプリケーションが実施した変更は、
		アプリケーションをビルドするだけで自動的に反映されます。

	  \item	自アプリケーションで実施したソース構成の変更は、
		ビルドを実施した時点でSpringhead側に反映されます。
		つまり、プロジェクトファイルの整合性を保つためには、
		ソース構成の変更後に少なくとも1回はビルドを実行する必要がある
		ということです(\tt{sync}の実行だけでもよい)。
		\begin{narrow}[s][15pt]
		ソース構成を変更したらビルドするでしょうから、
		このことが問題になることはほとんどないと思われます。

		もしSpringhead側でプロジェクトファイルが削除されたならば、
		ビルドエラー(\tt{sync}でlink先のファイルが見つからない)
		となります。
		
		{\bf{この場合にはSpringhead側で再度\cmake を実行する必要があります
		(アプリケーション側では駄目)。}}
		\end{narrow}

	  \item	\tt{sync}ターゲットが実行されるとプロジェクトファイルが更新される
		ことがあるため、\UpKQs プロジェクトが環境外で変更された\UpKQe 旨の
		メッセージが出ることがあります。
		「すべて再読み込み」としてください。
	\end{enumerate}

	\thinrule{\linewidth}
\end{narrow}	

% end: 3.2.CmakeApplication.tex
